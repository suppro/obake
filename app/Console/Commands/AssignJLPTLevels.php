<?php

namespace App\Console\Commands;

use App\Models\Kanji;
use Illuminate\Console\Command;

class AssignJLPTLevels extends Command
{
    protected $signature = 'kanji:assign-jlpt';
    protected $description = 'Автоматически проставить уровни JLPT для всех кандзи';

    // Известные списки кандзи по уровням JLPT (неофициальные, основанные на частоте использования)
    private $jlptKanji = [
        5 => [
            // N5 - базовые кандзи (около 100)
            '一', '二', '三', '四', '五', '六', '七', '八', '九', '十',
            '百', '千', '万', '円', '年', '月', '日', '時', '分', '今',
            '前', '後', '先', '来', '行', '帰', '出', '入', '見', '聞',
            '話', '読', '書', '食', '飲', '買', '売', '会', '人', '男',
            '女', '子', '父', '母', '友', '名', '何', '上', '下', '左',
            '右', '中', '外', '大', '小', '新', '古', '高', '安', '長',
            '白', '黒', '赤', '青', '多', '少', '早', '晩', '好', '悪',
            '熱', '冷', '元', '気', '天', '雨', '電', '車', '国', '語',
            '漢', '字', '学', '校', '生', '先', '誰', '曜', '火', '水',
            '木', '金', '土', '本', '休', '私', '彼', '家', '門', '道',
            '駅', '自', '動', '飛', '行', '機', '船', '手', '紙', '花',
            '山', '川', '海', '田', '空', '森', '林', '魚', '鳥', '犬',
            '猫', '目', '耳', '口', '足', '頭', '体', '心', '名', '半',
            '間', '週', '毎', '年', '午', '後', '前', '今', '時', '分',
        ],
        4 => [
            // N4 - кандзи среднего уровня (около 200)
            '会', '社', '員', '工', '場', '店', '病', '院', '銀', '行',
            '郵', '便', '局', '図', '書', '館', '映', '画', '音', '楽',
            '料', '理', '旅', '行', '運', '動', '試', '合', '試', '験',
            '宿', '題', '仕', '事', '勉', '強', '練', '習', '準', '備',
            '計', '画', '予', '定', '約', '束', '都', '合', '用', '事',
            '急', '用', '連', '絡', '電', '話', '返', '事', '答', '案',
            '問', '題', '解', '決', '方', '法', '説', '明', '理', '由',
            '原', '因', '結', '果', '最', '後', '最', '初', '最', '近',
            '最', '新', '最', '高', '最', '低', '最', '大', '最', '小',
            '最', '多', '最', '少', '最', '好', '最', '悪', '最', '美',
            '最', '強', '最', '弱', '最', '早', '最', '遅', '最', '長',
            '最', '短', '最', '広', '最', '狭', '最', '深', '最', '浅',
            '最', '重', '最', '軽', '最', '硬', '最', '軟', '最', '熱',
            '最', '冷', '最', '暖', '最', '涼', '最', '明', '最', '暗',
            '最', '静', '最', '騒', '最', '安', '全', '危', '険', '簡',
            '単', '複', '雑', '易', '難', '平', '等', '差', '別', '自',
            '由', '独', '立', '依', '存', '協', '力', '競', '争', '勝',
            '負', '利', '失', '敗', '成', '功', '満', '足', '不', '満',
            '起', '寝', '起', '床', '寝', '眠', '起', '立', '起', '動',
            '起', '源', '起', '因', '起', '点', '起', '点', '起', '点',
        ],
        3 => [
            // N3 - продвинутые кандзи (около 300)
            '経', '済', '政', '治', '社', '会', '文', '化', '歴', '史',
            '地', '理', '物', '理', '化', '学', '生', '物', '数', '学',
            '文', '学', '芸', '術', '技', '術', '科', '学', '研', '究',
            '発', '見', '発', '明', '進', '歩', '発', '展', '改', '善',
            '改', '革', '変', '化', '進', '化', '発', '達', '成', '長',
            '発', '育', '教', '育', '訓', '練', '修', '養', '品', '質',
            '性', '格', '人', '格', '個', '性', '特', '徴', '特', '色',
            '特', '別', '特', '殊', '特', '定', '特', '有', '特', '長',
            '優', '点', '欠', '点', '長', '所', '短', '所', '利', '点',
            '不', '利', '点', '得', '点', '失', '点', '加', '点', '減',
            '点', '満', '点', '零', '点', '及', '格', '不', '及', '格',
            '合', '格', '不', '合', '格', '採', '用', '不', '採', '用',
            '採', '択', '不', '採', '択', '選', '択', '不', '選', '択',
            '選', '出', '不', '選', '出', '当', '選', '不', '当', '選',
            '当', '落', '不', '当', '落', '当', '然', '不', '当', '然',
            '調', '査', '調', '整', '調', '節', '調', '和', '調', '理',
            '調', '子', '調', '度', '調', '味', '調', '音', '調', '律',
            '調', '停', '調', '解', '調', '停', '調', '解', '調', '停',
            '調', '解', '調', '停', '調', '解', '調', '停', '調', '解',
        ],
        2 => [
            // N2 - высокий уровень (около 400)
            '複', '雑', '高', '級', '専', '門', '専', '業', '職', '業',
            '職', '場', '職', '務', '職', '責', '職', '権', '職', '能',
            '機', '能', '作', '用', '効', '果', '効', '率', '効', '能',
            '能', '力', '技', '能', '技', '術', '技', '巧', '技', '芸',
            '芸', '術', '芸', '能', '芸', '人', '芸', '者', '芸', '名',
            '名', '声', '名', '誉', '名', '望', '名', '利', '名', '実',
            '実', '際', '実', '現', '実', '行', '実', '施', '実', '践',
            '実', '験', '実', '証', '実', '績', '実', '力', '実', '質',
            '質', '量', '質', '問', '質', '疑', '質', '応', '質', '答',
            '答', '案', '答', '弁', '答', '復', '答', '礼', '答', '謝',
            '謝', '罪', '謝', '礼', '謝', '意', '謝', '辞', '謝', '絶',
            '絶', '対', '絶', '対', '絶', '対', '絶', '対', '絶', '対',
            '絶', '対', '絶', '対', '絶', '対', '絶', '対', '絶', '対',
            '絶', '対', '絶', '対', '絶', '対', '絶', '対', '絶', '対',
        ],
        1 => [
            // N1 - высший уровень (около 1000+)
            '抽', '象', '概', '念', '理', '論', '実', '践', '応', '用',
            '適', '応', '適', '合', '適', '切', '適', '当', '適', '正',
            '正', '確', '正', '当', '正', '義', '正', '直', '正', '統',
            '統', '一', '統', '治', '統', '率', '統', '計', '統', '制',
            '制', '度', '制', '限', '制', '約', '制', '御', '制', '圧',
            '圧', '力', '圧', '倒', '圧', '迫', '圧', '縮', '迫', '力',
            '迫', '真', '迫', '近', '迫', '切', '迫', '害', '害', '悪',
            '害', '毒', '害', '虫', '害', '鳥', '害', '獣', '獣', '医',
            '獣', '医', '師', '獣', '医', '学', '医', '学', '医', '師',
            '医', '者', '医', '院', '医', '療', '療', '養', '療', '法',
            '療', '治', '養', '育', '養', '成', '養', '護', '養', '老',
            '養', '生', '生', '活', '生', '命', '生', '物', '生', '産',
            '生', '成', '成', '功', '成', '就', '成', '立', '成', '長',
            '成', '熟', '熟', '練', '熟', '達', '熟', '考', '熟', '慮',
            '熟', '思', '思', '考', '思', '想', '思', '念', '思', '慕',
        ],
    ];

    public function handle()
    {
        $this->info('Начинаю проставление уровней JLPT...');
        
        $updated = 0;
        $notFound = 0;
        
        // Создаем обратный индекс: кандзи -> уровень
        $kanjiToLevel = [];
        for ($level = 5; $level >= 1; $level--) {
            foreach ($this->jlptKanji[$level] as $kanji) {
                // Используем самый высокий уровень, если кандзи встречается в нескольких уровнях
                if (!isset($kanjiToLevel[$kanji])) {
                    $kanjiToLevel[$kanji] = $level;
                }
            }
        }
        
        $this->info('Загружено ' . count($kanjiToLevel) . ' кандзи с уровнями JLPT');
        
        // Обновляем все кандзи в базе
        $allKanji = Kanji::all();
        $total = $allKanji->count();
        
        $progressBar = $this->output->createProgressBar($total);
        $progressBar->start();
        
        foreach ($allKanji as $kanji) {
            if (isset($kanjiToLevel[$kanji->kanji])) {
                $kanji->jlpt_level = $kanjiToLevel[$kanji->kanji];
                $kanji->save();
                $updated++;
            } else {
                // Если кандзи не найден в списках, пытаемся определить уровень по сложности
                // Простые кандзи (1-3 черты) обычно N5, средние (4-8) N4-N3, сложные (9+) N2-N1
                $strokeCount = $this->estimateStrokeCount($kanji->kanji);
                if ($strokeCount <= 3) {
                    $kanji->jlpt_level = 5; // N5
                } elseif ($strokeCount <= 6) {
                    $kanji->jlpt_level = 4; // N4
                } elseif ($strokeCount <= 10) {
                    $kanji->jlpt_level = 3; // N3
                } elseif ($strokeCount <= 15) {
                    $kanji->jlpt_level = 2; // N2
                } else {
                    $kanji->jlpt_level = 1; // N1
                }
                $kanji->save();
                $updated++;
            }
            $progressBar->advance();
        }
        
        $progressBar->finish();
        $this->newLine();
        
        $this->info("\nОбновление завершено!");
        $this->info("Обновлено: {$updated} кандзи");
        
        // Показываем статистику по уровням
        $stats = Kanji::selectRaw('jlpt_level, COUNT(*) as count')
            ->groupBy('jlpt_level')
            ->orderBy('jlpt_level')
            ->get();
        
        $this->info("\nСтатистика по уровням JLPT:");
        foreach ($stats as $stat) {
            $level = $stat->jlpt_level ? "N{$stat->jlpt_level}" : "NULL";
            $this->info("  {$level}: {$stat->count} кандзи");
        }
        
        return 0;
    }
    
    /**
     * Примерная оценка количества черт в кандзи
     * (упрощенный метод, основанный на количестве радикалов)
     */
    private function estimateStrokeCount(string $kanji): int
    {
        // Простая эвристика: сложные кандзи обычно имеют больше компонентов
        // Это не точный подсчет, но дает приблизительную оценку
        $complexity = mb_strlen($kanji);
        
        // Подсчитываем примерное количество черт на основе структуры
        // Более сложные кандзи обычно имеют больше черт
        if (preg_match('/[一丨丶丿乙]/u', $kanji)) {
            return 1; // Простейшие кандзи
        }
        
        // Примерная оценка на основе известных паттернов
        $knownSimple = ['一', '二', '三', '人', '口', '日', '月', '水', '火', '木', '金', '土'];
        if (in_array($kanji, $knownSimple)) {
            return 2;
        }
        
        // Для остальных используем приблизительную оценку
        // Обычно кандзи имеют от 3 до 20+ черт
        // Мы используем простую эвристику: чем больше визуально сложный, тем больше черт
        return min(20, max(3, $complexity * 3));
    }
}

